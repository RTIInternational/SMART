{% extends "base.html" %}
{% block page_title %}Annotate Data{% endblock %}
{% load render_bundle from webpack_loader %}
{% load static %}
{% block content %}
<div id="mount"></main>
{% endblock %}

{% block scripts_body %}
<script type="text/javascript">
  window.PROJECT_ID = {{ pk }};
  {% if project.codebook_file == '' %}
    window.CODEBOOK_URL = ""
  {% else %}
    window.CODEBOOK_URL = "{% static project.codebook_file %}"
  {% endif %}
  window.ADMIN = {{admin}};
  window.onbeforeunload = function (e) {
    $.ajax({
      type: 'GET',
      async: false,
      url: '/api/leave_coding_page/'+{{ pk }}+'/',
    });
  };
  let init_access = false;
  window.onload = function (e) {
    $.ajax({
      type: 'GET',
      async: false,
      url: '/api/enter_coding_page/'+{{ pk }}+'/',
      success: function(result) {
        init_access = result["initial_admin_access"]
      }
    });
  };

  let pollingActive = true;

  function checkStatus() {
    if (pollingActive) {
      console.log("polling")
      $.ajax({
        type: "GET",
        async: false,
        url: '/api/check_coding_status/'+{{ pk }}+'/',
        dataType: 'json',
        success: function (result) {
          if (!init_access && !result["coding_access"]) {
            pollingActive = false;

            let content = $("#mount")
            // remove access to cards
            content.empty()
            content.append("<p>Your coding session has expired. Please refresh the page to retrieve cards<p>");
          };
          if (init_access && !result["admin_access"]) {
            init_access= false;
            // Add message that says message has expired, *but does not remove annnotation action*
            let content = $(".cardContent")
            content.empty()
            content.append("<p>Your admin session has expired. Please refresh the page to attempt to regain access<p>");

            $("[id$=tab-3], [id$=tab-4], [id$=tab-5]").remove();
          };
        }
      })
      setTimeout(checkStatus, 360000);
    }
  }

  $().ready(function() {
    setTimeout(function(){
      checkStatus();
    }, 360000);
  })
</script>
{% render_bundle 'smart' 'js' %}
{% endblock %}
